{% if g.popup %}
{% set popup = g.popup %}
<!-- Popup Container - LUÔN CENTER -->
<div id="bricon-popup" class="bricon-popup"
     data-popup-id="{{ popup.id }}"
     data-frequency="{{ popup.frequency }}"
     data-delay="{{ popup.delay_seconds }}"
     style="display: none;">

    <!-- Overlay -->
    <div class="bricon-popup-overlay"></div>

    <!-- Popup Content - LUÔN CENTER -->
    <div class="bricon-popup-content">
        <!-- Clickable Image -->
        {% if popup.link %}
        <a href="{{ popup.link }}" id="popup-link-{{ popup.id }}" class="bricon-popup-link">
            <img src="{{ popup.image }}" alt="Popup" class="bricon-popup-img">
        </a>
        {% else %}
        <img src="{{ popup.image }}" alt="Popup" class="bricon-popup-img">
        {% endif %}
    </div>
</div>

<!-- Popup Styles -->
<style>
.bricon-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    animation: fadeIn 0.3s ease-in;
}

.bricon-popup-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.75);
    backdrop-filter: blur(5px);
    cursor: pointer;
}

/* Content - LUÔN CENTER */
.bricon-popup-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: transparent;
    border-radius: 8px;
    overflow: hidden;
    max-width: 90vw;
    max-height: 90vh;
    animation: slideIn 0.4s ease-out;
}

/* Image */
.bricon-popup-link {
    display: block;
    cursor: pointer;
}

.bricon-popup-img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

/* Mobile Responsive - GẦN FULL */
@media (max-width: 768px) {
    .bricon-popup-overlay {
        background: rgba(0, 0, 0, 0.9); /* ✅ Tối hơn trên mobile */
    }

    .bricon-popup-content {
        max-width: 98vw; /* ✅ Gần full width */
        max-height: 85vh; /* ✅ Chiều cao 85% */
        width: 98vw;
    }

    .bricon-popup-img {
        width: 100%;
        height: auto;
        max-height: 85vh;
        object-fit: contain;
    }
}

/* Mobile nhỏ hơn */
@media (max-width: 480px) {
    .bricon-popup-content {
        max-width: 100vw;
        max-height: 90vh;
        width: 100vw;
    }

    .bricon-popup-img {
        max-height: 90vh;
    }
}
</style>

<!-- Popup JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const popup = document.getElementById('bricon-popup');
    if (!popup) return;

    const popupId = popup.dataset.popupId;
    const frequency = popup.dataset.frequency;
    const delay = parseInt(popup.dataset.delay) * 1000;

    // Cookie helpers
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }

    function setCookie(name, value, days) {
        if (days === 0) {
            // Session cookie - KHÔNG có expires
            document.cookie = `${name}=${value};path=/;SameSite=Lax`;
        } else {
            // Cookie có thời hạn
            const d = new Date();
            d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${d.toUTCString()};path=/;SameSite=Lax`;
        }
    }

    // Check if should show
    function shouldShowPopup() {
        const cookieName = `bricon_popup_${popupId}`;
        const lastShown = getCookie(cookieName);

        // Nếu chưa có cookie → show
        if (!lastShown) return true;

        // Mỗi ngày 1 lần
        if (frequency === 'once_per_day') {
            const lastDate = new Date(parseInt(lastShown));
            const now = new Date();
            return lastDate.toDateString() !== now.toDateString();
        }

        // Mỗi phiên 1 lần
        if (frequency === 'once_per_session') {
            return false; // Đã có cookie trong session → không show
        }

        // Mỗi lần vào trang
        if (frequency === 'every_visit') {
            return true;
        }

        return true;
    }

    // Show popup
    function showPopup() {
        popup.style.display = 'block';
        document.body.style.overflow = 'hidden';

        // Track view
        fetch(`/admin/api/popup/view/${popupId}`, { method: 'POST' })
            .catch(err => console.log('Tracking failed:', err));

        // Set cookie
        const cookieName = `bricon_popup_${popupId}`;
        if (frequency === 'once_per_day') {
            setCookie(cookieName, Date.now(), 1);
        } else if (frequency === 'once_per_session') {
            setCookie(cookieName, Date.now(), 0); // Session cookie
        }
        // every_visit không set cookie
    }

    // Hide popup
    function hidePopup() {
        popup.style.display = 'none';
        document.body.style.overflow = '';
    }

    // Close handlers
    const overlay = popup.querySelector('.bricon-popup-overlay');
    overlay.addEventListener('click', hidePopup);

    // ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && popup.style.display === 'block') {
            hidePopup();
        }
    });

    // Track click on link
    const popupLink = popup.querySelector('.bricon-popup-link');
    if (popupLink) {
        popupLink.addEventListener('click', function() {
            fetch(`/admin/api/popup/click/${popupId}`, { method: 'POST' })
                .catch(err => console.log('Tracking failed:', err));
        });
    }

    // Show popup with delay
    if (shouldShowPopup()) {
        setTimeout(showPopup, delay);
    }
});
</script>
{% endif %}