{% extends 'layouts/admin.html' %}

{% block page_title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4><i class="bi bi-building"></i> {{ title }}</h4>
    <a href="{{ url_for('admin.projects') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Quay lại
    </a>
</div>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header bg-warning">
                    <h6 class="mb-0">Thông tin dự án</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control", placeholder="VD: Dự án xây dựng website chuẩn SEO") }}
                        {% if form.title.errors %}
                        <div class="invalid-feedback d-block">
                            {% for error in form.title.errors %}{{ error }}{% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        {{ form.slug.label(class="form-label") }}
                        {{ form.slug(class="form-control") }}
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.client.label(class="form-label") }}
                            {{ form.client(class="form-control", placeholder="Tên khách hàng") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.location.label(class="form-label") }}
                            {{ form.location(class="form-control", placeholder="VD: TP.HCM") }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            {{ form.year.label(class="form-label") }}
                            {{ form.year(class="form-control", placeholder="2024") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.project_type.label(class="form-label") }}
                            {{ form.project_type(class="form-select") }}
                        </div>
                        <div class="col-md-4 mb-3">
                            {{ form.area.label(class="form-label") }}
                            {{ form.area(class="form-control", placeholder="VD: 500m²") }}
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", rows="3", placeholder="Mô tả ngắn về dự án") }}
                    </div>

                    <div class="mb-3">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", rows="10", id="content") }}
                        <small class="text-muted">Mô tả chi tiết về dự án, quy trình thực hiện...</small>
                    </div>

                    <div class="mb-3">
                        {{ form.products_used.label(class="form-label") }}
                        {{ form.products_used(class="form-control", rows="3", 
                           placeholder="VD: Keo dán gạch...") }}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">Ảnh đại diện</h6>
                </div>
                <div class="card-body">
                    {{ form.image.label(class="form-label") }}
                    {{ form.image(class="form-control mb-2") }}
                    {% if is_feature_enabled('media') %}
                        <button type="button"
                                class="btn btn-outline-primary btn-sm w-100"
                                onclick="openMediaPicker('image', 'imagePreview')">
                            <i class="bi bi-images"></i> Chọn từ thư viện
                        </button>
                    {% endif %}
                    {% if project and project.image %}
                    <img src="{{ project.image }}" 
                         class="img-fluid mt-3 rounded" 
                         alt="Preview"
                         id="imagePreview">
                    {% endif %}
                    
                    <input type="hidden" name="selected_image_path" id="selectedImagePath">
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">Cài đặt</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        {{ form.is_featured(class="form-check-input") }}
                        {{ form.is_featured.label(class="form-check-label") }}
                    </div>
                    
                    <div class="form-check">
                        {{ form.is_active(class="form-check-input") }}
                        {{ form.is_active.label(class="form-check-label") }}
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                {{ form.submit(class="btn btn-warning btn-lg") }}
                <a href="{{ url_for('admin.projects') }}" class="btn btn-secondary">Hủy</a>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.ckeditor.com/ckeditor5/39.0.0/classic/ckeditor.js"></script>
<script>
// CKEditor for content
ClassicEditor.create(document.querySelector('#content')).catch(error => {
    console.error(error);
});

// Auto-generate slug
document.querySelector('[name="title"]').addEventListener('input', function() {
    const slug = this.value
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[đĐ]/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');

    document.querySelector('[name="slug"]').value = slug;
});
</script>

{% if is_feature_enabled('media') %}
{% include 'components/media_picker.html' %}
{% endif %}
{% endblock %}