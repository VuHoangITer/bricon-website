{% extends "layouts/base.html" %}

{% block title %}Hệ thống đại lý - {{ get_setting('website_name', 'BRICON') }}{% endblock %}

{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

<style>
:root{
  --primary-yellow:#FFC107;
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#111827;
  --muted:#6b7280;
  --border:#e5e7eb;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.06);
  --shadow-md: 0 8px 22px rgba(0,0,0,.10);
  --radius:14px;
  --radius-sm:10px;
  --sidebar-width: 380px;
  --page-offset: 140px;
}

#main-content{ margin:0 !important; padding:0 !important; }

*{ box-sizing:border-box; }
body{
  background:var(--bg);
  color:var(--text);
}

/* ============ DESKTOP LAYOUT ============ */
.distributors-container{
  display:flex;
  height: calc(100svh - var(--page-offset));
  min-height: 660px;
  position:relative;
  overflow:hidden;
}

/* SIDEBAR - Desktop */
.distributors-sidebar{
  width: var(--sidebar-width);
  background: var(--card);
  border-right:1px solid var(--border);
  display:flex;
  flex-direction:column;
  position:relative;
  z-index:10;
}

/* Header */
.sidebar-header{
  padding: 16px 16px 12px;
  border-bottom:1px solid var(--border);
  background: var(--card);
  flex-shrink:0;
  position: sticky;
  top: 0;
  z-index: 2;
}

.sidebar-header h1{
  font-size: 1.125rem;
  font-weight: 800;
  margin: 0 0 12px 0;
  letter-spacing: -0.2px;
  color: var(--text);
}
.sidebar-header h1 i{ color: var(--muted); }

.search-wrapper{ position:relative; margin-bottom:10px; }
.search-input{
  width:100%;
  padding: 12px 40px 12px 12px;
  border:1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: .95rem;
  background:#fafafa;
  transition: .18s ease;
}
.search-input:focus{
  outline:none;
  background:#fff;
  border-color:#d1d5db;
  box-shadow: 0 0 0 3px rgba(17,24,39,.06);
}
.search-icon{
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent !important;
  border: 0 !important;
  box-shadow: none !important;
  width: auto !important;
  height: auto !important;
  padding: 0 !important;
  border-radius: 0 !important;
  color: #9ca3af;
  font-size: 1rem;
}

.filter-row{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
  margin-bottom:8px;
}
.filter-select{
  padding: 10px 10px;
  border:1px solid var(--border);
  border-radius: 12px;
  font-size: .85rem;
  background:#fff;
  transition:.18s ease;
}
.filter-select:focus{
  outline:none;
  border-color:#d1d5db;
  box-shadow: 0 0 0 3px rgba(17,24,39,.06);
}

.result-count{
  font-size: .85rem;
  color: var(--muted);
}
.result-count strong{ color: var(--text); }

/* List */
.distributors-list{
  flex:1;
  overflow-y:auto;
  padding: 14px;
  background: #fff;
}

/* Card */
.distributor-card{
  background: var(--card);
  border:1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  margin-bottom: 10px;
  cursor:pointer;
  transition: .18s ease;
  box-shadow: var(--shadow-sm);
  position:relative;
}
.distributor-card:hover{
  border-color:#d1d5db;
  box-shadow: var(--shadow-md);
}
.distributor-card.active{
  border-color: rgba(255,193,7,.65);
  box-shadow: 0 10px 24px rgba(255,193,7,.18);
  background: #fffdf6;
}

.distributor-card-header{
  display:flex;
  align-items:flex-start;
  gap:10px;
  margin-bottom:8px;
}
.distributor-icon{
  width:40px;
  height:40px;
  border-radius: 12px;
  background:#f3f4f6;
  border:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-shrink:0;
}
.distributor-icon i{ font-size:1.15rem; color:#374151; }

.distributor-info{ flex:1; min-width:0; }
.distributor-name{
  font-weight: 800;
  font-size: .98rem;
  color: var(--text);
  margin: 0 0 4px 0;
  line-height:1.25;
  letter-spacing: -0.1px;
}
.distributor-type{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:.72rem;
  padding: 3px 10px;
  border-radius: 999px;
  background:#f3f4f6;
  color:#374151;
  border:1px solid var(--border);
}

.distributor-address{
  font-size: .86rem;
  color: var(--muted);
  line-height: 1.45;
  display:-webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow:hidden;
  margin: 0 0 10px 0;
}
.distributor-address i{ color:#9ca3af; }

.distributor-contact{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  font-size:.82rem;
}
.contact-item{
  display:inline-flex;
  align-items:center;
  gap:6px;
  color:#111827;
  text-decoration:none;
  padding: 6px 10px;
  border-radius: 999px;
  background:#f9fafb;
  border:1px solid var(--border);
}
.contact-item i{ color:#6b7280; font-size:.9rem; }
a.contact-item:hover{
  background:#fff;
  box-shadow: var(--shadow-sm);
}

/* ============ MAP ============ */
.map-container{
  flex:1;
  position:relative;
  background: #f3f4f6;
}

.back-to-overview{
  position:absolute;
  top:14px;
  right:14px;
  z-index:10;
  background:#fff;
  border:1px solid var(--border);
  padding: 10px 12px;
  border-radius: 12px;
  font-weight: 800;
  font-size: .9rem;
  box-shadow: var(--shadow-sm);
  cursor:pointer;
  display:none;
  align-items:center;
  gap:8px;
  transition: .18s ease;
}
.back-to-overview:hover{
  box-shadow: var(--shadow-md);
  border-color:#d1d5db;
}
.back-to-overview.active{ display:flex; }

.overview-map,
.map-iframe-wrapper{
  width:100%;
  height:100%;
}
.map-iframe-wrapper{
  position:absolute;
  top:0; left:0;
  display:none;
  z-index:2;
}
.map-iframe-wrapper.active{ display:block; }
.map-iframe-wrapper iframe,
.overview-map iframe{
  width:100%;
  height:100%;
  border:none;
}

#overviewMapLeaflet{
  width:100%;
  height:100%;
  border-left:1px solid rgba(0,0,0,0.02);
}

.custom-marker{
  width:28px;
  height:28px;
  border-radius:999px;
  background:#ffc107;
  border:2px solid rgba(17,24,39,.20);
  box-shadow: 0 8px 18px rgba(0,0,0,.16);
  display:flex;
  align-items:center;
  justify-content:center;
}
.custom-marker i{
  color:#111827;
  font-size: 16px;
}
.custom-marker.featured{
  background: var(--primary-yellow);
  border-color: rgba(17,24,39,.20);
}
.custom-marker.featured i{ color:#111827; }

.leaflet-popup-content-wrapper{
  border-radius: 14px;
  padding: 0;
  box-shadow: var(--shadow-md);
}
.leaflet-popup-content{ margin:0; min-width: 220px; }
.popup-distributor{ padding: 12px; }
.popup-title{
  font-weight: 900;
  font-size: 14px;
  margin-bottom: 6px;
  color: var(--text);
}
.popup-address{
  font-size: 12.5px;
  color: var(--muted);
  margin-bottom: 10px;
  line-height: 1.45;
}
.popup-actions{ display:flex; gap:8px; }
.popup-btn{
  flex:1;
  padding: 8px 10px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 800;
  text-align:center;
  text-decoration:none;
  border:1px solid var(--border);
  transition:.18s ease;
}
.popup-btn-primary{
  background: var(--primary-yellow);
  color:#111827;
  border-color: rgba(255,193,7,.45);
}
.popup-btn-primary:hover{ filter: brightness(.98); box-shadow: var(--shadow-sm); }
.popup-btn-secondary{
  background:#fff;
  color:#111827;
}
.popup-btn-secondary:hover{ box-shadow: var(--shadow-sm); border-color:#d1d5db; }

.loading-spinner{ text-align:center; padding: 48px 12px; }
.spinner-border{
  width: 2.6rem;
  height: 2.6rem;
  border-width: .28rem;
  color: #111827;
  opacity: .25;
}
.empty-state{
  text-align:center;
  padding: 44px 12px;
  color: var(--muted);
}
.empty-state i{
  font-size: 2.5rem;
  margin-bottom: 10px;
  opacity: .25;
}

.distributors-list::-webkit-scrollbar{ width: 8px; }
.distributors-list::-webkit-scrollbar-track{ background: transparent; }
.distributors-list::-webkit-scrollbar-thumb{
  background: rgba(17,24,39,.18);
  border-radius: 999px;
}
.distributors-list::-webkit-scrollbar-thumb:hover{
  background: rgba(17,24,39,.28);
}

.leaflet-container a{ color: #111827; }

/* ============ MOBILE RESPONSIVE ============ */
@media (max-width: 768px) {
  :root {
    --page-offset: 60px;
  }

  /* Container mobile - dùng Grid để control layout */
  .distributors-container {
    display: grid;
    grid-template-rows: auto auto 1fr; /* Header | Map | List */
    height: 100vh;
    min-height: 100vh;
    overflow: hidden;
  }

  /* ===== 1. HEADER (sidebar-header) - grid-row: 1 ===== */
  .distributors-sidebar {
    width: 100%;
    border-right: none;
    display: contents; /* Phá vỡ container, cho phép con trực tiếp vào grid */
  }

  .sidebar-header {
    grid-row: 1; /* Hàng đầu tiên */
    padding: 12px 14px 10px;
    border-bottom: 1px solid var(--border);
    background: var(--card);
    position: relative;
    z-index: 10;
  }

  .sidebar-header h1 {
    font-size: 1rem;
    margin-bottom: 10px;
  }

  .search-input {
    padding: 10px 36px 10px 10px;
    font-size: .9rem;
  }

  .filter-row {
    grid-template-columns: 1fr;
    gap: 8px;
    margin-bottom: 10px;
  }

  .filter-select {
    padding: 11px 10px;
    font-size: .9rem;
  }

  .result-count {
    font-size: .82rem;
    margin-top: 4px;
  }

  /* ===== 2. MAP - grid-row: 2 ===== */
  .map-container {
    grid-row: 2; /* Hàng thứ hai */
    width: 100%;
    height: 200px;
    min-height: 200px;
    border-bottom: 1px solid var(--border);
  }

  #overviewMapLeaflet {
    border-left: none;
  }

  .back-to-overview {
    top: 10px;
    right: 10px;
    padding: 8px 10px;
    font-size: .85rem;
  }

  /* ===== 3. LIST - grid-row: 3 ===== */
  .distributors-list {
    grid-row: 3; /* Hàng thứ ba - chiếm phần còn lại */
    padding: 12px;
    overflow-y: auto; /* BẮT BUỘC có scroll */
    background: #fff;
    height: 100%; /* Chiếm full chiều cao được phân */
  }

  /* Card mobile */
  .distributor-card {
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 12px;
  }

  .distributor-card-header {
    gap: 8px;
    margin-bottom: 6px;
  }

  .distributor-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
  }

  .distributor-icon i {
    font-size: 1rem;
  }

  .distributor-name {
    font-size: .92rem;
  }

  .distributor-type {
    font-size: .7rem;
    padding: 2px 8px;
  }

  .distributor-address {
    font-size: .82rem;
    margin-bottom: 8px;
  }

  .distributor-contact {
    gap: 6px;
    font-size: .78rem;
  }

  .contact-item {
    padding: 5px 8px;
  }

  .contact-item i {
    font-size: .85rem;
  }

  .loading-spinner {
    padding: 32px 12px;
  }

  .spinner-border {
    width: 2rem;
    height: 2rem;
    border-width: .24rem;
  }

  .empty-state {
    padding: 32px 12px;
  }

  .empty-state i {
    font-size: 2rem;
  }

  .leaflet-popup-content {
    min-width: 180px;
  }

  .popup-distributor {
    padding: 10px;
  }

  .popup-title {
    font-size: 13px;
    margin-bottom: 5px;
  }

  .popup-address {
    font-size: 11.5px;
    margin-bottom: 8px;
  }

  .popup-btn {
    padding: 7px 8px;
    font-size: 11px;
  }
    .filter-row{
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 8px !important;
  }

  .filter-select{
    width: 100% !important;
    min-width: 0 !important;
    padding: 10px 8px !important;
    font-size: .85rem !important;
  }
  .detail-header{
    padding: 12px 14px;
  }

  .detail-title{
    font-size: 1rem;
  }

  .detail-body{
    padding: 14px;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  .distributors-sidebar {
    width: 340px;
  }

  .sidebar-header h1 {
    font-size: 1.05rem;
  }
}
.leaflet-control-zoom {
  display: none !important;
}
/* Detail View */
.distributor-detail{
  flex:1;
  overflow-y:auto;
  padding: 0;
  background: #fff;
}

.detail-header{
  padding: 16px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 2;
}

.btn-back{
  background: #f3f4f6;
  border: 1px solid var(--border);
  width: 36px;
  height: 36px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: .18s ease;
}

.btn-back:hover{
  background: #e5e7eb;
}

.detail-title{
  font-size: 1.1rem;
  font-weight: 800;
  margin: 0;
  flex: 1;
}

.detail-body{
  padding: 16px;
}

.detail-section{
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid #f3f4f6;
}

.detail-section:last-child{
  border-bottom: none;
}

.detail-section label{
  font-size: .85rem;
  font-weight: 700;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 8px;
}

.detail-section p{
  margin: 0;
  color: var(--text);
  line-height: 1.5;
}
</style>
{% endblock %}

{% block content %}
<div class="distributors-container">
  <div class="distributors-sidebar">
    <!-- HEADER - Mobile: hàng 1 -->
    <div class="sidebar-header">
      <h1><i class="bi bi-geo-alt"></i> Hệ thống đại lý</h1>

      <div class="search-wrapper">
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="Tìm theo tên, địa chỉ..."
          autocomplete="off"
        />
        <i class="bi bi-search search-icon"></i>
      </div>

      <div class="filter-row">
        <select class="filter-select" id="filterCity" style="grid-column: 1 / -1;">
          <option value="">Tất cả tỉnh/thành</option>
        </select>
      </div>

      <div class="result-count" id="resultCount">Đang tải...</div>
    </div>

    <!-- LIST - Mobile: hàng 3 (scroll được) -->
    <div class="distributors-list" id="distributorsList">
      <div class="loading-spinner">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Đang tải...</span>
        </div>
      </div>
    </div>
    <!-- DETAIL - Chi tiết đại lý (ẨN mặc định) -->
    <div class="distributor-detail" id="distributorDetail" style="display:none;">
      <div class="detail-header">
        <button class="btn-back" onclick="hideDetail()">
          <i class="bi bi-arrow-left"></i>
        </button>
        <h2 class="detail-title" id="detailName"></h2>
      </div>

      <div class="detail-body">
        <div class="detail-section">
          <label><i class="bi bi-geo-alt"></i> Địa chỉ</label>
          <p id="detailAddress"></p>
        </div>

        <div class="detail-section">
          <label><i class="bi bi-telephone"></i> Liên hệ</label>
          <p id="detailPhone"></p>
          <p id="detailEmail"></p>
        </div>

        <div class="detail-section">
          <label><i class="bi bi-clock"></i> Giờ làm việc</label>
          <p id="detailHours"></p>
        </div>

        <div class="detail-section" id="detailDescSection">
          <label><i class="bi bi-info-circle"></i> Mô tả</label>
          <p id="detailDescription"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- MAP - Mobile: hàng 2 (giữa header và list) -->
  <div class="map-container">
    <button class="back-to-overview" id="backToOverview" onclick="showOverviewMap()">
      <i class="bi bi-arrow-left"></i> Quay lại
    </button>

    <div class="overview-map" id="overviewMap">
      <div id="overviewMapLeaflet"></div>
    </div>

    <div class="map-iframe-wrapper" id="mapIframeWrapper"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
let allDistributors = [];
let selectedDistributor = null;
let overviewMapInstance = null;
let markerClusterGroup = null;

document.addEventListener('DOMContentLoaded', function() {
  initOverviewMap();
  loadDistributors();
  loadCities();
  setupEventListeners();
});

function initOverviewMap() {
  overviewMapInstance = L.map('overviewMapLeaflet').setView([16.0544, 108.2022], 6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom: 19
  }).addTo(overviewMapInstance);
  markerClusterGroup = L.markerClusterGroup({
    maxClusterRadius: 80,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false,
    zoomToBoundsOnClick: true
  });
  overviewMapInstance.addLayer(markerClusterGroup);
}

async function loadDistributors(params = {}) {
  try {
    const queryString = new URLSearchParams(params).toString();
    const response = await fetch(`/api/distributors?${queryString}`);
    const data = await response.json();
    if (data.success) {
      allDistributors = data.distributors;
      updateResultCount(data.count);
      renderDistributorsList(data.distributors);
      updateOverviewMap(data.distributors);
      document.getElementById('overviewMap').style.display = 'block';
      document.getElementById('mapIframeWrapper').classList.remove('active');
    }
  } catch (error) {
    console.error('Error loading distributors:', error);
    showError('Không thể tải danh sách đại lý');
  }
}

async function loadCities() {
  try {
    const response = await fetch('/api/distributors/cities');
    const data = await response.json();
    if (data.success) {
      const select = document.getElementById('filterCity');
      data.cities.forEach(city => {
        const option = document.createElement('option');
        option.value = city;
        option.textContent = city;
        select.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error loading cities:', error);
  }
}

function updateOverviewMap(distributors) {
  markerClusterGroup.clearLayers();
  const markers = [];
  distributors.forEach(d => {
    if (d.latitude && d.longitude) {
      const iconHtml = `<div class="custom-marker ${d.is_featured ? 'featured' : ''}">
        <i class="bi bi-shop"></i>
      </div>`;
      const customIcon = L.divIcon({
        html: iconHtml,
        className: 'custom-marker-wrapper',
        iconSize: d.is_featured ? [36, 36] : [32, 32],
        iconAnchor: d.is_featured ? [18, 18] : [16, 16]
      });
      const marker = L.marker([d.latitude, d.longitude], { icon: customIcon });
      const popupContent = `
        <div class="popup-distributor">
          <div class="popup-title">${d.name}</div>
          <div class="popup-address">
            <i class="bi bi-geo-alt"></i> ${d.full_address || d.address}
          </div>
          <div class="popup-actions">
            <a href="#" onclick="selectDistributorById(${d.id}); return false;" class="popup-btn popup-btn-primary">Xem</a>
            ${d.phone ? `<a href="tel:${d.phone}" class="popup-btn popup-btn-secondary">Gọi</a>` : ''}
          </div>
        </div>
      `;
      marker.bindPopup(popupContent);
      markers.push(marker);
    }
  });
  markerClusterGroup.addLayers(markers);
  if (markers.length > 1) {
    const group = L.featureGroup(markers);
    overviewMapInstance.fitBounds(group.getBounds().pad(0.1));
  } else {
    overviewMapInstance.setView([16.0544, 108.2022], 6);
  }
}

function renderDistributorsList(distributors) {
  const listContainer = document.getElementById('distributorsList');
  if (distributors.length === 0) {
    listContainer.innerHTML = `<div class="empty-state"><i class="bi bi-inbox"></i><p>Không tìm thấy đại lý nào</p></div>`;
    return;
  }
  listContainer.innerHTML = distributors.map(d => `
    <div class="distributor-card" data-id="${d.id}" onclick='selectDistributorById(${d.id})'>
      <div class="distributor-card-header">
        <div class="distributor-icon"><i class="bi bi-shop"></i></div>
        <div class="distributor-info">
          <h3 class="distributor-name">${d.name}</h3>
        </div>
      </div>
      <p class="distributor-address"><i class="bi bi-geo-alt"></i> ${d.full_address || d.address}</p>
    </div>
  `).join('');
}

function selectDistributorById(id) {
  const distributor = allDistributors.find(d => d.id === id);
  if (distributor) selectDistributor(distributor);
}

function selectDistributor(distributor) {
  selectedDistributor = distributor;

  // Highlight card (nếu vẫn trong list view)
  document.querySelectorAll('.distributor-card').forEach(card => {
    card.classList.remove('active');
  });
  const selectedCard = document.querySelector(`.distributor-card[data-id="${distributor.id}"]`);
  if (selectedCard) {
    selectedCard.classList.add('active');
  }

  // Hiển thị detail view
  showDetail(distributor);

  // Show map
  showMap(distributor);
}

// Hàm mới: Hiển thị detail
function showDetail(d) {
  // Ẩn list, hiện detail
  document.getElementById('distributorsList').style.display = 'none';
  document.getElementById('distributorDetail').style.display = 'block';

  // Điền thông tin
  document.getElementById('detailName').textContent = d.name;
  document.getElementById('detailAddress').textContent = d.full_address || d.address;
  document.getElementById('detailPhone').innerHTML = d.phone ? `<a href="tel:${d.phone}">${d.phone}</a>` : 'Chưa cập nhật';
  document.getElementById('detailEmail').innerHTML = d.email ? `<a href="mailto:${d.email}">${d.email}</a>` : '';
  document.getElementById('detailHours').textContent = d.working_hours || 'Chưa cập nhật';

  // Description (ẩn nếu không có)
  if (d.description) {
    document.getElementById('detailDescription').textContent = d.description;
    document.getElementById('detailDescSection').style.display = 'block';
  } else {
    document.getElementById('detailDescSection').style.display = 'none';
  }
}

// Hàm mới: Ẩn detail, hiện lại list
function hideDetail() {
  document.getElementById('distributorDetail').style.display = 'none';
  document.getElementById('distributorsList').style.display = 'block';

  // Clear active card
  document.querySelectorAll('.distributor-card').forEach(card => {
    card.classList.remove('active');
  });
  selectedDistributor = null;

  // Quay lại overview map
  showOverviewMap();
}

function showMap(distributor) {
  const overviewMap = document.getElementById('overviewMap');
  const iframeWrapper = document.getElementById('mapIframeWrapper');
  const backBtn = document.getElementById('backToOverview');
  if (distributor.map_iframe) {
    overviewMap.style.display = 'none';
    iframeWrapper.innerHTML = distributor.map_iframe;
    iframeWrapper.classList.add('active');
    backBtn.classList.add('active');
  } else {
    alert('Đại lý này chưa có bản đồ chi tiết');
  }
}

function showOverviewMap() {
  document.getElementById('overviewMap').style.display = 'block';
  document.getElementById('mapIframeWrapper').classList.remove('active');
  document.getElementById('backToOverview').classList.remove('active');
  document.querySelectorAll('.distributor-card').forEach(card => card.classList.remove('active'));
  selectedDistributor = null;
}

function updateResultCount(count) {
  document.getElementById('resultCount').innerHTML = `<strong>${count}</strong> đại lý`;
}

function showError(message) {
  document.getElementById('distributorsList').innerHTML = `<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>${message}</p></div>`;
}

function setupEventListeners() {
  let searchTimeout;
  document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => performSearch(), 500);
  });
  document.getElementById('filterCity').addEventListener('change', performSearch);
}

function performSearch() {
  const params = {
    search: document.getElementById('searchInput').value.trim(),
    city: document.getElementById('filterCity').value
  };
  selectedDistributor = null;
  loadDistributors(params);
}
</script>
{% endblock %}